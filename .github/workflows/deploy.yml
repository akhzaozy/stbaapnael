name: üöÄ Auto Copy to Kucingarong

on:
  push:
    branches:
      - main
      - development
      - feature/**
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Ambil source code
      - name: Checkout
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Kompres cepat (tanpa vendor/node_modules)
      - name: Create ZIP
        run: |
          zip -r deploy.zip . \
            -x "*.git*" "*.github*" "node_modules/*" "vendor/*" "storage/*" "*.env" "*.log"

      # 3Ô∏è‚É£ Upload ZIP ke server (hanya copy, selesai langsung)
      - name: Upload to STB
        env:
          AUTOHOST_URL: "https://deploy.akhzafachrozy.my.id/"  # GANTI ke IP STB kamu
          REPO_NAME: ${{ github.event.repository.name }}
        run: |
          echo "üöÄ Uploading $REPO_NAME..."
          RESPONSE=$(curl -s -S -m 60 --connect-timeout 10 \
            -X POST \
            -F "repo=$REPO_NAME" \
            -F "file=@deploy.zip" \
            "$AUTOHOST_URL")
          echo "üìú ===== RESPONSE ====="
          echo "$RESPONSE"
          echo "üìú ===================="

      # 4Ô∏è‚É£ Hapus ZIP setelah upload
      - name: Cleanup
        run: rm -f deploy.zip
