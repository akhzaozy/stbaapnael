name: üêæ Kucingarong Deploy v6.0

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      subdomain:
        description: 'Subdomain name (optional - defaults to repo name)'
        required: false
        type: string
      force_full:
        description: 'Force full deployment (ignore incremental detection)'
        required: false
        type: boolean
        default: false

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    # =======================================================
    # üì• Step 1: Checkout Repository
    # =======================================================
    - name: üì• Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    # =======================================================
    # ‚öôÔ∏è Step 2: Setup Environment Variables
    # =======================================================
    - name: üîß Setup Environment
      id: setup
      run: |
        REPO_NAME="${GITHUB_REPOSITORY##*/}"
        SUBDOMAIN="${{ github.event.inputs.subdomain }}"
        if [ -z "$SUBDOMAIN" ]; then
          SUBDOMAIN="$REPO_NAME"
        fi
        echo "repo_name=$REPO_NAME" >> $GITHUB_OUTPUT
        echo "subdomain=$SUBDOMAIN" >> $GITHUB_OUTPUT
        echo "üì¶ Repository: $REPO_NAME"
        echo "üåê Subdomain: $SUBDOMAIN"

    # =======================================================
    # üîç Step 3: Detect Changed Files for Incremental Deploy
    # =======================================================
    - name: üîç Detect Changed Files
      id: changes
      run: |
        FORCE_FULL="${{ github.event.inputs.force_full }}"
        if [ "$FORCE_FULL" = "true" ]; then
          echo "mode=full" >> $GITHUB_OUTPUT
          echo "üì¶ Mode: Full deployment (forced)"
        elif [ "${{ github.event_name }}" = "workflow_dispatch" ] || [ -z "${{ github.event.before }}" ]; then
          echo "mode=full" >> $GITHUB_OUTPUT
          echo "üì¶ Mode: Full deployment (manual/initial)"
        else
          CHANGED_FILES=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }})
          if [ -z "$CHANGED_FILES" ]; then
            echo "mode=full" >> $GITHUB_OUTPUT
            echo "üì¶ Mode: Full (no changes detected)"
          else
            # Check if critical files changed
            CRITICAL_CHANGED=$(echo "$CHANGED_FILES" | grep -E "(composer\.(json|lock)|artisan|\.env\.example|database/)" || true)
            if [ -n "$CRITICAL_CHANGED" ]; then
              echo "mode=full" >> $GITHUB_OUTPUT
              echo "üì¶ Mode: Full (critical files changed)"
            else
              echo "mode=incremental" >> $GITHUB_OUTPUT
              echo "üì¶ Mode: Incremental"
            fi
            echo "$CHANGED_FILES" > changed_files.txt
            echo "üìù Changed files:"
            cat changed_files.txt
            FILE_COUNT=$(wc -l < changed_files.txt)
            echo "file_count=$FILE_COUNT" >> $GITHUB_OUTPUT
          fi
        fi

    # =======================================================
    # üì¶ Step 4: Create ZIP Package (Full or Incremental)
    # =======================================================
    - name: üì¶ Create Deployment Package
      run: |
        MODE="${{ steps.changes.outputs.mode }}"
        if [ "$MODE" = "incremental" ]; then
          echo "üì¶ Creating incremental package..."
          cat changed_files.txt | zip -@ deploy.zip
          CRITICAL_FILES=("composer.json" "composer.lock" "artisan" ".env.example")
          for file in "${CRITICAL_FILES[@]}"; do
            if [ -f "$file" ] && ! grep -q "^$file$" changed_files.txt 2>/dev/null; then
              zip -u deploy.zip "$file" 2>/dev/null || true
            fi
          done
          echo "‚úÖ Incremental package created ($(du -h deploy.zip | cut -f1))"
        else
          echo "üì¶ Creating full package..."
          zip -r deploy.zip . \
            -x "*.git*" \
            -x "node_modules/*" \
            -x "vendor/*" \
            -x "*.github/*" \
            -x "storage/logs/*" \
            -x ".env" \
            -x "*.log" \
            -x "tests/*" \
            -x ".DS_Store" \
            -x "*.md"
          echo "‚úÖ Full package created ($(du -h deploy.zip | cut -f1))"
        fi

    # =======================================================
    # üöÄ Step 5: Upload to Server via CURL
    # =======================================================
    - name: üöÄ Upload to Server
      id: upload
      run: |
        MODE="${{ steps.changes.outputs.mode }}"
        echo "üåê Uploading deploy.zip to https://deploy.akhzafachrozy.my.id/"
        RESPONSE=$(curl -s -S -w "\n%{http_code}" -X POST \
          -F "file=@deploy.zip" \
          -F "repo=${{ steps.setup.outputs.repo_name }}" \
          -F "subdomain=${{ steps.setup.outputs.subdomain }}" \
          -F "mode=$MODE" \
          -F "commit_sha=${{ github.sha }}" \
          "https://deploy.akhzafachrozy.my.id/")
        HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
        BODY=$(echo "$RESPONSE" | head -n-1)
        echo "üì° Response Code: $HTTP_CODE"
        echo "$BODY"
        if [ "$HTTP_CODE" -eq 200 ]; then
          echo "‚úÖ Upload successful!"
          echo "response=$BODY" >> $GITHUB_OUTPUT
        else
          echo "‚ùå Upload failed with code $HTTP_CODE"
          exit 1
        fi

    # =======================================================
    # üßæ Step 6: Parse Response & Extract Port Information
    # =======================================================
    - name: üß† Extract Deployment Details
      id: parse
      run: |
        RESPONSE='${{ steps.upload.outputs.response }}'
        PORT=$(echo "$RESPONSE" | grep -o '"port":[0-9]*' | cut -d':' -f2)
        REPO="${{ steps.setup.outputs.repo_name }}"
        SUBDOMAIN="${{ steps.setup.outputs.subdomain }}"
        MODE="${{ steps.changes.outputs.mode }}"
        echo "port=$PORT" >> $GITHUB_OUTPUT
        echo "üìä Detected deployment details:"
        echo "   Repo      : $REPO"
        echo "   Subdomain : $SUBDOMAIN"
        echo "   Mode      : $MODE"
        echo "   Port      : $PORT"

    # =======================================================
    # ‚úÖ Step 7: Deployment Summary in Console
    # =======================================================
    - name: ‚úÖ Deployment Complete
      run: |
        MODE="${{ steps.changes.outputs.mode }}"
        PORT="${{ steps.parse.outputs.port }}"
        SERVER_IP="${{ secrets.SERVER_IP }}"
        echo "================================================"
        echo "üéâ Deployment Initiated Successfully!"
        echo "================================================"
        echo "üì¶ Repository : ${{ steps.setup.outputs.repo_name }}"
        echo "üåê Subdomain  : ${{ steps.setup.outputs.subdomain }}"
        echo "üìä Mode       : $MODE"
        echo "üî¢ Port       : $PORT"
        echo ""
        if [ "$MODE" = "incremental" ]; then
          echo "üìù Incremental update started..."
        else
          echo "üöÄ Full setup in progress..."
        fi
        echo ""
        echo "üîó Direct Access (without Cloudflare):"
        if [ -n "$SERVER_IP" ]; then
          echo "   http://$SERVER_IP:$PORT"
        else
          echo "   http://YOUR_SERVER_IP:$PORT"
        fi
        echo ""
        echo "‚è≥ Check server logs:"
        echo "   /var/log/bg_lite_${{ steps.setup.outputs.repo_name }}.log"
        echo "   /var/log/laravel-${{ steps.setup.outputs.repo_name }}.log"
        echo "================================================"

    # =======================================================
    # üìù Step 8: Deployment Summary in GitHub UI (Markdown)
    # =======================================================
    - name: üìù Deployment Summary
      if: always()
      run: |
        MODE="${{ steps.changes.outputs.mode }}"
        PORT="${{ steps.parse.outputs.port }}"
        REPO="${{ steps.setup.outputs.repo_name }}"
        SUBDOMAIN="${{ steps.setup.outputs.subdomain }}"
        SERVER_IP="${{ secrets.SERVER_IP }}"
        cat >> $GITHUB_STEP_SUMMARY << EOF
        ## üêæ Kucingarong Deployment Report
        
        ### üìä Deployment Information
        - **Repository**: \`$REPO\`
        - **Subdomain**: \`$SUBDOMAIN\`
        - **Mode**: \`$MODE\`
        - **Port**: \`$PORT\`
        - **Commit**: \`${{ github.sha }}\`
        
        ### üîó Access Your Application
        EOF

        if [ -n "$SERVER_IP" ]; then
          echo "**Direct URL**: [http://$SERVER_IP:$PORT](http://$SERVER_IP:$PORT)" >> $GITHUB_STEP_SUMMARY
        else
          echo "**Direct URL**: \`http://YOUR_SERVER_IP:$PORT\`" >> $GITHUB_STEP_SUMMARY
        fi

        cat >> $GITHUB_STEP_SUMMARY << EOF
        
        > üí° **Note**: Setup Cloudflare Tunnel manually to get custom domain
        
        ---
        
        ### üß† Server Details
        | Item | Path / Command |
        |------|----------------|
        | **Laravel Service** | \`laravel-$REPO\` |
        | **App Directory** | \`/www/wwwroot/hosting/$REPO\` |
        | **Background Log** | \`/var/log/bg_lite_$REPO.log\` |
        | **Laravel Log** | \`/var/log/laravel-$REPO.log\` |
        | **Port** | \`$PORT\` |
        | **Deploy Log** | \`/www/wwwroot/deploy.log\` |
        
        ---
        
        ### ‚öôÔ∏è Useful Commands
        \`\`\`bash
        # Check Laravel service status
        sudo systemctl status laravel-$REPO
        
        # View Laravel realtime logs
        sudo journalctl -u laravel-$REPO -f
        
        # View background deployment logs
        sudo tail -f /var/log/bg_lite_$REPO.log
        
        # Restart Laravel service
        sudo systemctl restart laravel-$REPO
        
        # Access application directory
        cd /www/wwwroot/hosting/$REPO
        \`\`\`
        
        ---
        ### ‚è±Ô∏è Deployment Progress
        EOF

        if [ "$MODE" = "full" ]; then
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
        1. ‚úÖ Files uploaded (full)
        2. ‚úÖ Environment setup (.env)
        3. ‚úÖ Storage directories created
        4. ‚úÖ Composer install
        5. ‚úÖ Laravel key generated
        6. ‚úÖ Database migrations
        7. ‚úÖ Cache optimization
        8. ‚úÖ Laravel service started
        
        **Estimated time:** 2‚Äì5 minutes
        EOF
        else
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
        1. ‚úÖ Incremental files uploaded
        2. ‚úÖ Files synced intelligently
        3. ‚úÖ Composer update (if needed)
        4. ‚úÖ Cache cleared & rebuilt
        5. ‚úÖ Service restarted
        
        **Estimated time:** 30‚Äì60 seconds
        EOF
        fi

        cat >> $GITHUB_STEP_SUMMARY << EOF
        
        ---
        
        ### üåê Setup Cloudflare Tunnel (Manual)
        \`\`\`bash
        # Install cloudflared if not installed
        wget https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
        sudo dpkg -i cloudflared-linux-amd64.deb
        
        # Create tunnel
        cloudflared tunnel create $SUBDOMAIN
        
        # Configure tunnel to point to port $PORT
        cloudflared tunnel route dns $SUBDOMAIN $SUBDOMAIN.yourdomain.com
        
        # Run tunnel
        cloudflared tunnel --url http://localhost:$PORT run $SUBDOMAIN
        \`\`\`
        
        ---
        ‚è±Ô∏è *Deployment started at: $(date)*  
        ‚úÖ **Laravel running on port:** $PORT  
        üìÅ **Location:** \`/www/wwwroot/hosting/$REPO\`  
        üêæ *Powered by Kucingarong Lite Deploy v6.0*
        EOF
