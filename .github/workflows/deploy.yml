name: ğŸš€ Auto Deploy to Kucingarong (Async)

on:
  push:
    branches:
      - main
      - development
      - feature/**
  workflow_dispatch:

jobs:
  deploy:
    name: ğŸ”§ Deploy Laravel Project
    runs-on: ubuntu-latest

    steps:
      # ============================
      # ğŸ§© 1. Checkout Repository
      # ============================
      - name: Checkout Repository
        uses: actions/checkout@v4

      # ============================
      # ğŸ“¦ 2. Prepare Deploy ZIP
      # ============================
      - name: Create Deploy Archive
        run: |
          echo "ğŸ“¦ Zipping project..."
          zip -r deploy.zip . \
            -x "*.git*" "*.github*" "node_modules/*" "vendor/*" "storage/*" \
            "*.env" "*.log" "tests/*"

      # ============================
      # ğŸš€ 3. Upload to STB Server
      # ============================
      - name: Deploy to Kucingarong AutoHost
        env:
          # âš™ï¸ Ganti ke URL server kamu
          # Disarankan: gunakan IP langsung atau DNS-only (tanpa Cloudflare proxy)
          AUTOHOST_URL: "http://103.xxx.xxx.xxx"  # atau "https://cicak.akhzafachrozy.my.id"
          REPO_NAME: ${{ github.event.repository.name }}
        run: |
          echo "ğŸš€ Deploying $REPO_NAME to $AUTOHOST_URL..."
          echo "ğŸ•“ $(date)"
          
          RESPONSE=$(curl -s -S -m 300 --connect-timeout 15 \
            -X POST \
            -F "repo=$REPO_NAME" \
            -F "file=@deploy.zip" \
            "$AUTOHOST_URL")
          
          echo "ğŸ“œ ====== SERVER RESPONSE ======"
          echo "$RESPONSE"
          echo "ğŸ“œ ============================="

      # ============================
      # ğŸ§¹ 4. Optional Cleanup
      # ============================
      - name: Cleanup workspace
        run: rm -f deploy.zip
