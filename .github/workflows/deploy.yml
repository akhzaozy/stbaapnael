name: üêæ Kucingarong Deploy

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      subdomain:
        description: 'Subdomain name (optional - uses repo name if empty)'
        required: false
        type: string
      force_full:
        description: 'Force full deployment (ignore incremental)'
        required: false
        type: boolean
        default: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: üì• Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Fetch all history for comparison
      
    - name: üîß Setup Environment
      id: setup
      run: |
        # Get repo name
        REPO_NAME="${GITHUB_REPOSITORY##*/}"
        echo "repo_name=$REPO_NAME" >> $GITHUB_OUTPUT
        
        # Use custom subdomain or repo name
        SUBDOMAIN="${{ github.event.inputs.subdomain }}"
        if [ -z "$SUBDOMAIN" ]; then
          SUBDOMAIN="$REPO_NAME"
        fi
        echo "subdomain=$SUBDOMAIN" >> $GITHUB_OUTPUT
        
        echo "üì¶ Repository: $REPO_NAME"
        echo "üåê Subdomain: $SUBDOMAIN"
    
    - name: üîç Detect Changed Files
      id: changes
      run: |
        FORCE_FULL="${{ github.event.inputs.force_full }}"
        
        if [ "$FORCE_FULL" = "true" ]; then
          echo "mode=full" >> $GITHUB_OUTPUT
          echo "üì¶ Mode: Full deployment (forced)"
        elif [ "${{ github.event_name }}" = "workflow_dispatch" ] || [ -z "${{ github.event.before }}" ]; then
          echo "mode=full" >> $GITHUB_OUTPUT
          echo "üì¶ Mode: Full deployment (initial or manual)"
        else
          # Get changed files since last commit
          CHANGED_FILES=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }})
          
          if [ -z "$CHANGED_FILES" ]; then
            echo "mode=full" >> $GITHUB_OUTPUT
            echo "üì¶ Mode: Full deployment (no changes detected)"
          else
            echo "mode=incremental" >> $GITHUB_OUTPUT
            echo "$CHANGED_FILES" > changed_files.txt
            echo "üì¶ Mode: Incremental deployment"
            echo "üìù Changed files:"
            cat changed_files.txt
            
            # Count files
            FILE_COUNT=$(wc -l < changed_files.txt)
            echo "file_count=$FILE_COUNT" >> $GITHUB_OUTPUT
          fi
        fi
    
    - name: üì¶ Create Deployment Package
      run: |
        MODE="${{ steps.changes.outputs.mode }}"
        
        if [ "$MODE" = "incremental" ]; then
          echo "üì¶ Creating incremental package..."
          
          # Create zip with only changed files
          cat changed_files.txt | zip -@ deploy.zip
          
          # Always include critical files if they exist
          CRITICAL_FILES=("composer.json" "composer.lock" ".env.example" "artisan")
          for file in "${CRITICAL_FILES[@]}"; do
            if [ -f "$file" ] && ! grep -q "^$file$" changed_files.txt; then
              zip -u deploy.zip "$file" 2>/dev/null || true
            fi
          done
          
          echo "‚úÖ Incremental package created: $(du -h deploy.zip | cut -f1)"
          echo "üìä Files: ${{ steps.changes.outputs.file_count }}"
        else
          echo "üì¶ Creating full package..."
          
          # Exclude unnecessary files
          zip -r deploy.zip . \
            -x "*.git*" \
            -x "node_modules/*" \
            -x "*.github/*" \
            -x "tests/*" \
            -x "*.md" \
            -x ".env" \
            -x "storage/logs/*" \
            -x "vendor/*" \
            -x ".DS_Store" \
            -x "*.log"
          
          echo "‚úÖ Full package created: $(du -h deploy.zip | cut -f1)"
        fi
    
    - name: üöÄ Upload to Server
      id: upload
      run: |
        MODE="${{ steps.changes.outputs.mode }}"
        
        RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
          -F "file=@deploy.zip" \
          -F "repo=${{ steps.setup.outputs.repo_name }}" \
          -F "subdomain=${{ steps.setup.outputs.subdomain }}" \
          -F "mode=$MODE" \
          -F "commit_sha=${{ github.sha }}" \
          "https://deploy.akhzafachrozy.my.id/")
        
        HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
        BODY=$(echo "$RESPONSE" | head -n-1)
        
        echo "üì° Response Code: $HTTP_CODE"
        echo "$BODY"
        
        if [ "$HTTP_CODE" -eq 200 ]; then
          echo "‚úÖ Upload successful!"
          echo "response=$BODY" >> $GITHUB_OUTPUT
        else
          echo "‚ùå Upload failed with code $HTTP_CODE"
          exit 1
        fi
    
    - name: ‚úÖ Deployment Complete
      run: |
        MODE="${{ steps.changes.outputs.mode }}"
        
        echo "================================================"
        echo "üéâ Deployment Initiated Successfully!"
        echo "================================================"
        echo ""
        echo "üì¶ Repository: ${{ steps.setup.outputs.repo_name }}"
        echo "üåê Subdomain: ${{ steps.setup.outputs.subdomain }}"
        echo "üìä Mode: $MODE"
        
        if [ "$MODE" = "incremental" ]; then
          echo "üìù Files updated: ${{ steps.changes.outputs.file_count }}"
        fi
        
        echo ""
        echo "‚è≥ Background Processing:"
        
        if [ "$MODE" = "full" ]; then
          echo "   1. ‚úÖ Files uploaded (full)"
          echo "   2. üîÑ Installing dependencies (composer install)"
          echo "   3. üîÑ Configuring environment (.env)"
          echo "   4. üîÑ Generating application key"
          echo "   5. üîÑ Starting Laravel service"
          echo "   6. üîÑ Setting up Cloudflare tunnel"
        else
          echo "   1. ‚úÖ Files uploaded (incremental)"
          echo "   2. üîÑ Extracting changed files"
          echo "   3. üîÑ Running composer update (if needed)"
          echo "   4. üîÑ Restarting Laravel service"
        fi
        
        echo ""
        echo "üîó Your app will be available at:"
        echo "   https://${{ steps.setup.outputs.subdomain }}.trycloudflare.com"
        echo ""
        
        if [ "$MODE" = "full" ]; then
          echo "‚è±Ô∏è  Setup usually takes 2-5 minutes"
        else
          echo "‚è±Ô∏è  Update usually takes 30-60 seconds"
        fi
        
        echo "üìä Check logs at: /var/log/bg_lite_${{ steps.setup.outputs.repo_name }}.log"
        echo "================================================"
    
    - name: üìù Deployment Summary
      if: always()
      run: |
        MODE="${{ steps.changes.outputs.mode }}"
        
        cat >> $GITHUB_STEP_SUMMARY << 'EOF'
        ## üêæ Kucingarong Deployment
        
        ### üìä Deployment Status
        - **Status**: ‚úÖ Upload Complete - Processing in Background
        - **Repository**: `${{ steps.setup.outputs.repo_name }}`
        - **Subdomain**: `${{ steps.setup.outputs.subdomain }}`
        - **Mode**: `$MODE`
        - **Commit**: `${{ github.sha }}`
        EOF
        
        if [ "$MODE" = "incremental" ]; then
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
        - **Files Updated**: ${{ steps.changes.outputs.file_count }}
        EOF
        fi
        
        cat >> $GITHUB_STEP_SUMMARY << 'EOF'
        
        ### üîó Access Your Application
        ```
        https://${{ steps.setup.outputs.subdomain }}.trycloudflare.com
        ```
        
        ### ‚è≥ Background Tasks
        EOF
        
        if [ "$MODE" = "full" ]; then
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
        The following processes are running on the server:
        1. üì¶ Installing dependencies (composer install)
        2. üîß Setting up environment (.env)
        3. üîë Generating application key
        4. üöÄ Starting Laravel service (systemd)
        5. üåê Connecting Cloudflare tunnel
        
        **Estimated time**: 2-5 minutes
        EOF
        else
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
        The following processes are running on the server:
        1. üì¶ Extracting changed files
        2. üîÑ Updating dependencies (if needed)
        3. üîÑ Clearing cache
        4. üîÑ Restarting service
        
        **Estimated time**: 30-60 seconds
        EOF
        fi
        
        cat >> $GITHUB_STEP_SUMMARY << 'EOF'
        
        ### üìä Monitoring
        - **Server Logs**: `/var/log/bg_lite_${{ steps.setup.outputs.repo_name }}.log`
        - **Deploy Logs**: `/www/wwwroot/deploy.log`
        - **Service**: `laravel-${{ steps.setup.outputs.repo_name }}`
        
        ### üõ†Ô∏è Management Commands
        ```bash
        # Check service status
        sudo systemctl status laravel-${{ steps.setup.outputs.repo_name }}
        
        # View logs
        sudo journalctl -u laravel-${{ steps.setup.outputs.repo_name }} -f
        
        # Restart service
        sudo systemctl restart laravel-${{ steps.setup.outputs.repo_name }}
        ```
        
        ### üîÑ Deployment Type
        EOF
        
        if [ "$MODE" = "full" ]; then
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
        This was a **full deployment**. All files were uploaded and processed.
        
        To force incremental deployment next time, ensure you're pushing to an existing deployment.
        EOF
        else
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
        This was an **incremental deployment**. Only changed files were uploaded.
        
        Changed files:
        ```
        EOF
          cat changed_files.txt >> $GITHUB_STEP_SUMMARY
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
        ```
        
        To force full deployment, use manual dispatch with "Force full deployment" checked.
        EOF
        fi
        
        cat >> $GITHUB_STEP_SUMMARY << 'EOF'
        
        ---
        ‚è±Ô∏è *Deployment initiated at: $(date)*
        EOF
