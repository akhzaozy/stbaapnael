name: ðŸ¾ Kucingarong Quick Deploy v7.0

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      subdomain:
        description: 'Subdomain name (optional - defaults to repo name)'
        required: false
        type: string
      force_full:
        description: 'Force full deployment'
        required: false
        type: boolean
        default: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
    # =======================================================
    # ðŸ“¥ Checkout Repository
    # =======================================================
    - name: ðŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    # =======================================================
    # âš™ï¸ Setup Environment
    # =======================================================
    - name: ðŸ”§ Setup Environment
      id: setup
      run: |
        REPO_NAME="${GITHUB_REPOSITORY##*/}"
        SUBDOMAIN="${{ github.event.inputs.subdomain }}"
        if [ -z "$SUBDOMAIN" ]; then
          SUBDOMAIN="$REPO_NAME"
        fi
        echo "repo_name=$REPO_NAME" >> $GITHUB_OUTPUT
        echo "subdomain=$SUBDOMAIN" >> $GITHUB_OUTPUT
        echo "ðŸ“¦ Repository: $REPO_NAME"
        echo "ðŸŒ Subdomain: $SUBDOMAIN"

    # =======================================================
    # ðŸ” Detect Changes (Smart Deploy)
    # =======================================================
    - name: ðŸ” Detect Changed Files
      id: changes
      run: |
        FORCE_FULL="${{ github.event.inputs.force_full }}"
        if [ "$FORCE_FULL" = "true" ]; then
          echo "mode=full" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Mode: Full (forced)"
        elif [ "${{ github.event_name }}" = "workflow_dispatch" ] || [ -z "${{ github.event.before }}" ]; then
          echo "mode=full" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Mode: Full (manual/initial)"
        else
          CHANGED_FILES=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} || echo "")
          if [ -z "$CHANGED_FILES" ]; then
            echo "mode=full" >> $GITHUB_OUTPUT
            echo "ðŸ“¦ Mode: Full (no changes)"
          else
            CRITICAL_CHANGED=$(echo "$CHANGED_FILES" | grep -E "(composer\.(json|lock)|artisan|\.env\.example|database/|config/)" || true)
            if [ -n "$CRITICAL_CHANGED" ]; then
              echo "mode=full" >> $GITHUB_OUTPUT
              echo "ðŸ“¦ Mode: Full (critical files changed)"
            else
              echo "mode=incremental" >> $GITHUB_OUTPUT
              echo "ðŸ“¦ Mode: Incremental ($(echo "$CHANGED_FILES" | wc -l) files)"
            fi
          fi
        fi

    # =======================================================
    # ðŸ“¦ Create ZIP Package
    # =======================================================
    - name: ðŸ“¦ Create Package
      run: |
        MODE="${{ steps.changes.outputs.mode }}"
        echo "ðŸ“¦ Creating deployment package..."
        
        # Always include critical files for proper deployment
        zip -r deploy.zip . \
          -x "*.git*" \
          -x "node_modules/*" \
          -x "vendor/*" \
          -x "*.github/*" \
          -x "storage/logs/*" \
          -x ".env" \
          -x "*.log" \
          -x "tests/*" \
          -x ".DS_Store"
        
        SIZE=$(du -h deploy.zip | cut -f1)
        echo "âœ… Package created: $SIZE"

    # =======================================================
    # ðŸš€ Quick Upload (No Processing on GitHub Side)
    # =======================================================
    - name: ðŸš€ Quick Upload to Server
      id: upload
      run: |
        MODE="${{ steps.changes.outputs.mode }}"
        echo "ðŸŒ Uploading to server..."
        
        RESPONSE=$(curl -s -S -w "\n%{http_code}" -X POST \
          --max-time 30 \
          -F "file=@deploy.zip" \
          -F "repo=${{ steps.setup.outputs.repo_name }}" \
          -F "subdomain=${{ steps.setup.outputs.subdomain }}" \
          -F "mode=$MODE" \
          -F "commit_sha=${{ github.sha }}" \
          "https://deploy.akhzafachrozy.my.id/")
        
        HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
        BODY=$(echo "$RESPONSE" | head -n-1)
        
        echo "ðŸ“¡ Response: $HTTP_CODE"
        
        if [ "$HTTP_CODE" -eq 200 ]; then
          echo "âœ… Upload successful!"
          echo "$BODY"
          echo "response=$BODY" >> $GITHUB_OUTPUT
        else
          echo "âŒ Upload failed"
          echo "$BODY"
          exit 1
        fi

    # =======================================================
    # ðŸ§¾ Parse Response
    # =======================================================
    - name: ðŸ§  Extract Details
      id: parse
      run: |
        RESPONSE='${{ steps.upload.outputs.response }}'
        PORT=$(echo "$RESPONSE" | grep -o '"port":[0-9]*' | cut -d':' -f2 || echo "0")
        echo "port=$PORT" >> $GITHUB_OUTPUT
        echo "âœ… Port: $PORT"

    # =======================================================
    # âœ… Summary
    # =======================================================
    - name: ðŸ“ Deployment Summary
      if: always()
      run: |
        MODE="${{ steps.changes.outputs.mode }}"
        PORT="${{ steps.parse.outputs.port }}"
        REPO="${{ steps.setup.outputs.repo_name }}"
        SERVER_IP="${{ secrets.SERVER_IP }}"
        
        cat >> $GITHUB_STEP_SUMMARY << EOF
        ## ðŸ¾ Kucingarong Quick Deploy
        
        ### âœ… Upload Completed
        - **Repository**: \`$REPO\`
        - **Mode**: \`$MODE\`
        - **Port**: \`$PORT\`
        - **Status**: Files uploaded successfully
        
        ### â³ Background Processing
        Server is now processing:
        1. ðŸ”§ Installing dependencies (composer)
        2. âš™ï¸ Setting up Laravel environment
        3. ðŸ”‘ Generating app keys
        4. ðŸ—„ï¸ Running migrations
        5. ðŸš€ Starting Laravel service
        
        **Estimated time**: 3-5 minutes
        
        ### ðŸ”— Access URL
        EOF
        
        if [ -n "$SERVER_IP" ] && [ "$PORT" != "0" ]; then
          echo "**Direct**: [http://$SERVER_IP:$PORT](http://$SERVER_IP:$PORT)" >> $GITHUB_STEP_SUMMARY
        else
          echo "**Port**: \`$PORT\` (use your server IP)" >> $GITHUB_STEP_SUMMARY
        fi
        
        cat >> $GITHUB_STEP_SUMMARY << EOF
        
        ### ðŸ“Š Monitor Progress
        \`\`\`bash
        # Check background process
        sudo tail -f /var/log/bg_deploy_$REPO.log
        
        # Check Laravel service
        sudo systemctl status laravel-$REPO
        
        # View Laravel logs
        sudo tail -f /var/log/laravel-$REPO.log
        \`\`\`
        
        ---
        *âš¡ Quick deploy completed in < 1 minute*  
        *ðŸ”„ Full setup running in background on server*
        EOF
